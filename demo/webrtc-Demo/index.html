<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC + Go Demo</title>
</head>
<body>
  <h2>WebRTC + Go (pion) Demo</h2>
  <button id="start">Start Audio</button>
  <br/>
  <!-- æ’­æ”¾è¿œç«¯éŸ³é¢‘ï¼Œå¸¦æŽ§åˆ¶æ¡æ–¹ä¾¿è°ƒè¯• -->
  <audio id="remoteAudio" autoplay controls></audio>

  <script>
  const pc = new RTCPeerConnection();
  const ws = new WebSocket("ws://localhost:8080/ws");

  ws.onopen = () => {
    console.log("âœ… WebSocket connected");
  };

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === "answer") {
      console.log("ðŸ“¥ Received SDP Answer");
      await pc.setRemoteDescription(new RTCSessionDescription(msg));
    } else if (msg.candidate) {
      console.log("ðŸ“¥ Received ICE Candidate from server");
      await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
    }
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      console.log("ðŸ“¤ Sending ICE Candidate to server");
      ws.send(JSON.stringify({ candidate: e.candidate }));
    } else {
      console.log("âœ… ICE Gathering complete");
    }
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ðŸ“¡ ICE connection state:", pc.iceConnectionState);
  };

  pc.onconnectionstatechange = () => {
    console.log("ðŸŽ‰ PeerConnection state:", pc.connectionState);
  };

  // ç›‘å¬è¿œç«¯è½¨é“äº‹ä»¶ï¼Œç»‘å®šåˆ° audio æ ‡ç­¾
  pc.ontrack = (event) => {
    console.log("ðŸ”Š Received remote track:", event.track.kind);
    const remoteAudio = document.getElementById("remoteAudio");
    if (remoteAudio.srcObject !== event.streams[0]) {
      remoteAudio.srcObject = event.streams[0];
      console.log("â–¶ï¸ Playing remote audio stream");
    }
  };

  document.getElementById("start").onclick = async () => {
    try {
      console.log("ðŸŽ¤ Getting user audio...");
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => {
        console.log("ðŸŽ§ Adding track to PeerConnection:", track.kind);
        pc.addTrack(track, stream);
      });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      console.log("ðŸ“¤ Sending SDP Offer to server");
      ws.send(JSON.stringify(offer));
    } catch (err) {
      console.error("Error accessing user media or creating offer:", err);
    }
  };
  </script>
</body>
</html>
