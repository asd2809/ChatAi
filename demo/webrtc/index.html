<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC with Go</title>
</head>
<body>
  <h2>WebRTC + Go (pion)</h2>
  <button id="start">Start Audio</button>
  <!-- æ’­æ”¾è¿œç«¯éŸ³é¢‘ -->
  <audio id="remoteAudio" autoplay></audio>

  <script>
  const pc = new RTCPeerConnection();
  const ws = new WebSocket("ws://localhost:8080/ws");

  ws.onopen = () => {
    console.log("âœ… WebSocket connected");
  };

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === "answer") {
      console.log("ðŸ“¥ Received SDP Answer");
      await pc.setRemoteDescription(new RTCSessionDescription(msg));
    } else if (msg.candidate) {
      console.log("ðŸ“¥ Received ICE Candidate from server");
      await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
    }
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ðŸ“¡ ICE connection state:", pc.iceConnectionState);
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      console.log("ðŸ“¤ Sending ICE Candidate to server");
      ws.send(JSON.stringify({ candidate: e.candidate }));
    } else {
      console.log("âœ… ICE Gathering complete");
    }
  };

  pc.onconnectionstatechange = () => {
    console.log("ðŸŽ‰ PeerConnection state:", pc.connectionState);
  };

  // æ–°å¢žï¼šç›‘å¬è¿œç«¯è½¨é“äº‹ä»¶ï¼Œç»‘å®šåˆ° audio æ ‡ç­¾æ’­æ”¾
  pc.ontrack = (event) => {
    console.log("ðŸ”Š Received remote track:", event.track.kind);
    const remoteAudio = document.getElementById("remoteAudio");
    // event.streams[0] æ˜¯è¿œç«¯åª’ä½“æµ
    if (remoteAudio.srcObject !== event.streams[0]) {
      remoteAudio.srcObject = event.streams[0];
      console.log("â–¶ï¸ Playing remote audio stream");
    }
  };

  document.getElementById("start").onclick = async () => {
    console.log("ðŸŽ¤ Getting user audio...");
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(track => {
      console.log("ðŸŽ§ Adding track to PeerConnection:", track.kind);
      pc.addTrack(track, stream);
    });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    console.log("ðŸ“¤ Sending SDP Offer to server");
    ws.send(JSON.stringify(offer));
  };
  </script>
</body>
</html>
